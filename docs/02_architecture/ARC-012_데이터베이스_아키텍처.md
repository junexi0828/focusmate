---
id: ARC-012
title: 데이터베이스 아키텍처
version: 1.0
status: Active
date: 2025-12-18
author: Focus Mate Team
iso_standard: ISO/IEC 42010
---

# 데이터베이스 아키텍처 문서

**문서 버전**: 1.0
**작성일**: 2025-12-18
**데이터베이스**: PostgreSQL (Supabase)
**테이블 수**: 38개

---

## 목차

1. [개요](#1-개요)
2. [데이터베이스 스키마](#2-데이터베이스-스키마)
3. [테이블 상세](#3-테이블-상세)
4. [인덱싱 전략](#4-인덱싱-전략)
5. [마이그레이션 관리](#5-마이그레이션-관리)
6. [성능 최적화](#6-성능-최적화)

---

## 1. 개요

### 1.1 데이터베이스 선택

**PostgreSQL**을 주 데이터베이스로 선택한 이유:
- ACID 트랜잭션 보장
- JSONB 타입 지원 (유연한 데이터 구조)
- 강력한 인덱싱 (B-tree, GiST, GIN)
- 비동기 드라이버 지원 (asyncpg)
- 확장성 (Horizontal/Vertical Scaling)

### 1.2 연결 정보

```python
# 비동기 연결 (애플리케이션)
DATABASE_URL = "postgresql+asyncpg://user:pass@host:5432/focusmate"

# 동기 연결 (마이그레이션)
SYNC_DATABASE_URL = "postgresql://user:pass@host:5432/focusmate"
```

### 1.3 연결 풀 설정

```python
# SQLAlchemy Engine 설정
engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,           # 기본 연결 수
    max_overflow=10,        # 추가 연결 수
    pool_timeout=30,        # 연결 대기 시간
    pool_recycle=3600,      # 연결 재사용 시간
    echo=False              # SQL 로깅 (개발: True)
)
```

---

## 2. 데이터베이스 스키마

### 2.1 전체 테이블 목록 (38개)

```mermaid
erDiagram
    USER ||--o{ ROOM : creates
    USER ||--o{ SESSION_HISTORY : has
    USER ||--o{ USER_ACHIEVEMENT : earns
    USER ||--o{ USER_GOALS : sets
    USER ||--o{ POST : writes
    USER ||--o{ FRIEND_REQUEST : sends
    USER ||--o{ FRIEND : has

    ROOM ||--o{ PARTICIPANT : has
    ROOM ||--o{ TIMER : has
    ROOM ||--o{ ROOM_RESERVATIONS : has

    POST ||--o{ COMMENT : has
    POST ||--o{ POST_LIKE : receives
    POST ||--o{ POST_READ : tracked

    USER ||--o{ RANKING_SESSIONS : participates
    RANKING_TEAMS ||--o{ RANKING_TEAM_MEMBERS : has
    RANKING_TEAMS ||--o{ RANKING_TEAM_INVITATIONS : sends
```

### 2.2 도메인별 테이블 분류

#### 핵심 도메인 (Core)
1. `user` - 사용자 정보
2. `room` - 포모도로 방
3. `participant` - 방 참여자
4. `timer` - 타이머 상태
5. `session_history` - 세션 기록

#### 사용자 관리 (User Management)
6. `user_settings` - 사용자 설정
7. `user_goals` - 사용자 목표
8. `user_achievement` - 사용자 업적
9. `achievement` - 업적 정의
10. `user_verification` - 사용자 인증

#### 예약 시스템 (Reservation)
11. `room_reservations` - 방 예약
12. `manual_sessions` - 수동 세션

#### 커뮤니티 (Community)
13. `post` - 게시글
14. `comment` - 댓글
15. `post_like` - 게시글 좋아요
16. `comment_like` - 댓글 좋아요
17. `post_read` - 게시글 읽음 추적

#### 랭킹 시스템 (Ranking)
18. `ranking_leaderboard` - 리더보드
19. `ranking_sessions` - 랭킹 세션
20. `ranking_teams` - 팀
21. `ranking_team_members` - 팀 멤버
22. `ranking_team_invitations` - 팀 초대
23. `ranking_mini_games` - 미니 게임
24. `ranking_verification_requests` - 인증 요청

#### 매칭 시스템 (Matching)
25. `matching_pools` - 매칭 풀
26. `matching_proposals` - 매칭 제안
27. `matching_chat_rooms` - 매칭 채팅방
28. `matching_chat_members` - 채팅방 멤버
29. `matching_messages` - 매칭 메시지

#### 메시징 시스템 (Messaging)
30. `chat_rooms` - 채팅방
31. `chat_members` - 채팅방 멤버
32. `chat_messages` - 채팅 메시지
33. `conversation` - 대화
34. `message` - 메시지

#### 친구 시스템 (Friends)
35. `friend` - 친구 관계
36. `friend_request` - 친구 요청

#### 알림 시스템 (Notifications)
37. `notifications` - 알림

#### 시스템 (System)
38. `alembic_version` - 마이그레이션 버전

---

## 3. 테이블 상세

### 3.1 핵심 테이블

#### user (사용자)
```sql
CREATE TABLE user (
    id VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    bio TEXT,
    total_focus_time INTEGER DEFAULT 0,
    total_sessions INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX ix_user_email ON user(email);
CREATE INDEX ix_user_username ON user(username);
```

**주요 필드**:
- `id`: UUID 기본 키
- `email`: 이메일 (고유, 인덱스)
- `username`: 사용자명 (고유, 인덱스)
- `hashed_password`: bcrypt 해시 비밀번호
- `total_focus_time`: 총 집중 시간 (초)
- `total_sessions`: 총 세션 수

#### room (포모도로 방)
```sql
CREATE TABLE room (
    id VARCHAR(36) PRIMARY KEY,
    room_name VARCHAR(100) NOT NULL,
    host_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    work_duration_minutes INTEGER DEFAULT 25,
    break_duration_minutes INTEGER DEFAULT 5,
    auto_start_break BOOLEAN DEFAULT TRUE,
    max_participants INTEGER DEFAULT 50,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX ix_room_host_id ON room(host_id);
CREATE INDEX ix_room_is_active ON room(is_active);
```

#### session_history (세션 기록)
```sql
CREATE TABLE session_history (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    room_id VARCHAR(36) REFERENCES room(id) ON DELETE SET NULL,
    session_type VARCHAR(10) NOT NULL, -- 'work' or 'break'
    duration_minutes INTEGER NOT NULL,
    completed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    room_name VARCHAR(100)
);

CREATE INDEX ix_session_history_user_id ON session_history(user_id);
CREATE INDEX ix_session_history_completed_at ON session_history(completed_at);
```

### 3.2 커뮤니티 테이블

#### post (게시글)
```sql
CREATE TABLE post (
    id VARCHAR(36) PRIMARY KEY,
    author_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50),
    tags TEXT[],
    view_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    is_pinned BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX ix_post_author_id ON post(author_id);
CREATE INDEX ix_post_category ON post(category);
CREATE INDEX ix_post_created_at ON post(created_at DESC);
CREATE INDEX ix_post_is_pinned ON post(is_pinned) WHERE is_pinned = TRUE;
```

#### comment (댓글)
```sql
CREATE TABLE comment (
    id VARCHAR(36) PRIMARY KEY,
    post_id VARCHAR(36) REFERENCES post(id) ON DELETE CASCADE,
    author_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    parent_comment_id VARCHAR(36) REFERENCES comment(id) ON DELETE CASCADE,
    like_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX ix_comment_post_id ON comment(post_id);
CREATE INDEX ix_comment_author_id ON comment(author_id);
CREATE INDEX ix_comment_parent_comment_id ON comment(parent_comment_id);
```

### 3.3 랭킹 시스템 테이블

#### ranking_leaderboard (리더보드)
```sql
CREATE TABLE ranking_leaderboard (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    total_score INTEGER DEFAULT 0,
    rank INTEGER,
    weekly_score INTEGER DEFAULT 0,
    monthly_score INTEGER DEFAULT 0,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX ix_ranking_leaderboard_user_id ON ranking_leaderboard(user_id);
CREATE INDEX ix_ranking_leaderboard_total_score ON ranking_leaderboard(total_score DESC);
CREATE INDEX ix_ranking_leaderboard_rank ON ranking_leaderboard(rank);
```

#### ranking_teams (팀)
```sql
CREATE TABLE ranking_teams (
    id VARCHAR(36) PRIMARY KEY,
    team_name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    leader_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    total_score INTEGER DEFAULT 0,
    member_count INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX ix_ranking_teams_leader_id ON ranking_teams(leader_id);
CREATE INDEX ix_ranking_teams_total_score ON ranking_teams(total_score DESC);
```

### 3.4 매칭 시스템 테이블

#### matching_pools (매칭 풀)
```sql
CREATE TABLE matching_pools (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) REFERENCES user(id) ON DELETE CASCADE,
    preferred_duration INTEGER,
    preferred_break INTEGER,
    status VARCHAR(20) DEFAULT 'waiting', -- 'waiting', 'matched', 'cancelled'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX ix_matching_pools_user_id ON matching_pools(user_id);
CREATE INDEX ix_matching_pools_status ON matching_pools(status);
CREATE INDEX ix_matching_pools_created_at ON matching_pools(created_at);
```

---

## 4. 인덱싱 전략

### 4.1 기본 인덱스

모든 테이블에 자동 생성되는 인덱스:
- **Primary Key**: B-tree 인덱스 (id)
- **Foreign Key**: 참조 무결성 검사용

### 4.2 성능 최적화 인덱스

#### 자주 조회되는 필드
```sql
-- 사용자 조회
CREATE INDEX ix_user_email ON user(email);
CREATE INDEX ix_user_username ON user(username);

-- 세션 기록 조회 (날짜 범위)
CREATE INDEX ix_session_history_completed_at ON session_history(completed_at);
CREATE INDEX ix_session_history_user_id_completed_at
    ON session_history(user_id, completed_at DESC);

-- 게시글 조회 (최신순)
CREATE INDEX ix_post_created_at ON post(created_at DESC);

-- 리더보드 조회 (점수순)
CREATE INDEX ix_ranking_leaderboard_total_score
    ON ranking_leaderboard(total_score DESC);
```

#### 복합 인덱스
```sql
-- 사용자별 세션 조회 (최신순)
CREATE INDEX ix_session_user_date
    ON session_history(user_id, completed_at DESC);

-- 방별 참여자 조회
CREATE INDEX ix_participant_room_user
    ON participant(room_id, user_id);
```

#### 부분 인덱스 (Partial Index)
```sql
-- 활성 방만 인덱싱
CREATE INDEX ix_room_active
    ON room(is_active)
    WHERE is_active = TRUE;

-- 고정 게시글만 인덱싱
CREATE INDEX ix_post_pinned
    ON post(is_pinned)
    WHERE is_pinned = TRUE;
```

---

## 5. 마이그레이션 관리

### 5.1 Alembic 설정

**현재 마이그레이션 버전**: `20251218_profile_settings (head)`

**마이그레이션 체인**:
```
<base> → cb008620275b (initial_schema)
       → c7c2df775040 (add_missing_tables)
       → 20251212_2000 (add_post_read_table)
       → f14ca0bf1539 (add_user_verification_table)
       → 20251218_0001 (add_room_reservation_fields)
       → 20251218_profile_settings (head)
```

### 5.2 마이그레이션 명령어

```bash
# 현재 버전 확인
alembic current

# 마이그레이션 히스토리
alembic history

# 최신 버전으로 업그레이드
alembic upgrade head

# 특정 버전으로 업그레이드
alembic upgrade 20251218_0001

# 다운그레이드
alembic downgrade -1

# 새 마이그레이션 생성
alembic revision --autogenerate -m "description"
```

### 5.3 마이그레이션 모범 사례

1. **자동 생성 후 검토**: `--autogenerate` 사용 후 수동 검토 필수
2. **트랜잭션 사용**: 마이그레이션 실패 시 롤백
3. **데이터 마이그레이션**: 스키마 변경 시 기존 데이터 처리
4. **백업**: 프로덕션 마이그레이션 전 백업 필수

---

## 6. 성능 최적화

### 6.1 쿼리 최적화

#### N+1 문제 해결
```python
# 나쁜 예 (N+1 쿼리)
users = await session.execute(select(User))
for user in users:
    sessions = await session.execute(
        select(SessionHistory).where(SessionHistory.user_id == user.id)
    )

# 좋은 예 (JOIN 사용)
result = await session.execute(
    select(User, SessionHistory)
    .join(SessionHistory)
    .options(selectinload(User.sessions))
)
```

#### 페이지네이션
```python
# LIMIT/OFFSET 사용
query = select(Post).order_by(Post.created_at.desc())
query = query.limit(20).offset(page * 20)
```

### 6.2 연결 풀 관리

```python
# 연결 풀 모니터링
engine.pool.size()      # 현재 연결 수
engine.pool.overflow()  # 추가 연결 수
```

### 6.3 캐싱 전략

- **Redis 캐싱**: 자주 조회되는 데이터 (리더보드, 통계)
- **Query 캐싱**: TanStack Query (프론트엔드)
- **TTL 설정**: 데이터 특성에 따라 조정

---

## 7. 백업 및 복구

### 7.1 백업 전략

```bash
# 전체 데이터베이스 백업
pg_dump -h host -U user -d focusmate > backup_$(date +%Y%m%d).sql

# 특정 테이블 백업
pg_dump -h host -U user -d focusmate -t user -t session_history > backup.sql
```

### 7.2 복구

```bash
# 데이터베이스 복구
psql -h host -U user -d focusmate < backup_20251218.sql
```

---

## 8. 모니터링

### 8.1 성능 지표

- **쿼리 실행 시간**: 평균 < 100ms
- **연결 풀 사용률**: < 80%
- **인덱스 사용률**: > 90%

### 8.2 슬로우 쿼리 로깅

```sql
-- PostgreSQL 설정
ALTER DATABASE focusmate SET log_min_duration_statement = 1000; -- 1초 이상
```

---

## 9. 참고 문서

- [TECH-001: 기술 스택](file:///Users/juns/FocusMate/docs/00_overview/TECH-001_기술_스택.md)
- [ARC-001: 시스템 아키텍처](file:///Users/juns/FocusMate/docs/02_architecture/ARC-001_System_Architecture.md)
- [OPS-002: 의존성 수정](file:///Users/juns/FocusMate/docs/05_operations/OPS-002_Dependency_Fix.md)

---

**문서 끝**
